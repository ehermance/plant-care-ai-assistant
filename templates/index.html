<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Plant Care AI Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css', v=1) }}">
</head>
<body>
  <a class="skip-link" href="#main">Skip to main content</a>

  <header>
    <h1>Plant Care AI Assistant</h1>
    <p class="muted">Rule-based ➜ Weather-aware ➜ (optional) OpenAI, with graceful fallback.</p>
  </header>

  <main id="main" role="main">
    <form id="qa-form" action="/ask" method="post" novalidate aria-describedby="form-help" aria-live="polite" aria-busy="false">
      <!-- Loading overlay -->
      <div class="loader-overlay" aria-hidden="true">
        <div class="thinking" aria-live="polite" aria-atomic="true" role="status">
          thinking<span class="dots"></span>
        </div>
      </div>

      <p id="form-help" class="sr-only">Enter a plant name and city (optional), and your question. The question is required.</p>

      <div class="row form-row">
        <div class="input-col">
          <label for="plant">Plant (optional)</label>
          <input
            id="plant" name="plant" type="text" inputmode="text" autocapitalize="words" autocomplete="off" spellcheck="false"
            placeholder="e.g., Monstera deliciosa"
            value="{{ (form_values and form_values.plant) or '' }}"
            maxlength="80"
            aria-describedby="plant-help"
          >
          <div id="plant-help" class="sr-only">Up to 80 characters. Letters/numbers plus common punctuation like spaces, hyphens, apostrophes, parentheses, commas, periods, slashes, ampersand.</div>
        </div>

        <div class="input-col">
          <label for="city">City (optional)</label>
          <input
            id="city" name="city" type="text" inputmode="text" autocapitalize="words" autocomplete="address-level2" spellcheck="false"
            placeholder="e.g., Austin"
            value="{{ (form_values and form_values.city) or '' }}"
            maxlength="80"
            aria-describedby="city-help"
          >
          <div id="city-help" class="sr-only">Up to 80 characters. Letters/numbers plus common punctuation.</div>
        </div>
      </div>

      <div>
        <label for="question">Your question <span aria-hidden="true">*</span></label>
        <textarea
          id="question" name="question" rows="4" placeholder="e.g., How do lilacs get their flower color?"
          required maxlength="1200" aria-describedby="question-help"
          autocomplete="off" spellcheck="true"
        >{{ (form_values and form_values.question) or '' }}</textarea>
        <div id="question-help" class="sr-only">Required. Maximum 1200 characters.</div>
      </div>

      <div class="row j-between ai-center">
        <button id="submitBtn" class="primary" type="submit" aria-label="Submit question">Ask</button>
        <div>
          <a class="muted" href="/healthz" target="_blank" rel="noopener noreferrer">Health check</a>
          <span class="muted"> • </span>
          <a class="muted" href="/debug" target="_blank" rel="noopener noreferrer">Debug info</a>
        </div>
      </div>

      <div id="sr-status" class="sr-only" aria-live="assertive" aria-atomic="true"></div>

      <noscript>
        <p class="notice small">JavaScript is disabled. Submissions will work, but you won’t see a loading indicator or form lock during processing.</p>
      </noscript>
    </form>

    <!-- Presets panel -->
    <section id="presets-container" class="presets card" hidden aria-labelledby="presets-heading">
      <h2 id="presets-heading" class="m0">Recommended for your area</h2>
      <p class="muted">Region: <span id="presets-region">…</span>. Click a card to prefill the form.</p>
      <ul id="presets-list"></ul>
    </section>

    {% if weather %}
      <section class="card" aria-labelledby="weather-heading">
        <h2 id="weather-heading" class="m0">Local Weather</h2>
        <p>
          <strong>{{ weather.city }}</strong> — {{ weather.conditions or 'N/A' }}<br>
          Temp: {{ weather.temp_c }} °C • Humidity: {{ weather.humidity }}% • Wind: {{ weather.wind_mps }} m/s
        </p>
      </section>
    {% endif %}

    {% if answer %}
      {% if ai_error and source == 'rule' %}
        <div class="notice small" role="alert">
          <strong>AI unavailable</strong>: {{ ai_error }}<br>
          The app fell back to rule-based advice. See <a href="/debug" target="_blank" rel="noopener noreferrer">/debug</a> for details.
        </div>
      {% endif %}

      <section class="card" aria-labelledby="answer-heading">
        <div class="row j-between ai-center">
          <h2 id="answer-heading" class="m0">Answer</h2>
          {% if source %}
            <span class="pill" title="How this answer was generated">
              {{ source == 'ai' and 'AI' or 'Rule' }}
            </span>
          {% endif %}
        </div>
        <div class="small">
          <pre class="m0">{{ answer }}</pre>
        </div>
      </section>
      <p class="muted small mt075">
        Generated by: <strong>{{ source == 'ai' and 'OpenAI (fallback-safe)' or 'Rule-based engine' }}</strong>
      </p>
    {% endif %}

    <section class="card" aria-labelledby="history-heading">
      <div class="row j-between ai-center">
        <h2 id="history-heading" class="m0">Recent Q&A</h2>
        <a class="small" href="/history/clear" title="Clear in-memory history">Clear</a>
      </div>
      {% if history and history|length > 0 %}
        <ul class="history">
          {% for item in history %}
            <li>
              <div class="small muted mono">{{ item.ts }}</div>
              <div class="small">
                <span class="pill">{{ item.source == 'ai' and 'AI' or 'Rule' }}</span>
                {% if item.plant %}<strong>Plant:</strong> {{ item.plant }} • {% endif %}
                {% if item.city %}<strong>City:</strong> {{ item.city }}{% endif %}
              </div>
              <div class="small mt04">
                <strong>Q:</strong> {{ item.question }}
              </div>
              <details class="mt075">
                <summary class="small">Show answer</summary>
                <pre class="small mt075">{{ item.answer }}</pre>
              </details>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted small">No questions yet. Ask something above to populate the history.</p>
      {% endif %}
    </section>
  </main>

  <script defer src="{{ url_for('static', filename='app.js', v=4) }}"></script>
</body>
</html>
