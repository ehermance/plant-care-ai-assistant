{% extends "base.html" %}

{% block title %}Dashboard - Plant Care AI Assistant - PlantCareAI{% endblock %}

{% block content %}
<!-- Welcome Section -->
<section class="mb-8">
  <h2 class="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-slate-100 mb-2">
    {% set hour = now().hour %}
    {% if hour < 12 %}Good morning{% elif hour < 18 %}Good afternoon{% else %}Good evening{% endif %}!
    <span class="inline-block animate-float" aria-hidden="true">ğŸŒ±</span>
  </h2>
  <p class="text-lg text-slate-600 dark:text-slate-400">
    {% if plant_count == 0 %}
      Welcome to your plant care dashboard. Let's add your first plant!
    {% elif plant_count == 1 %}
      You're caring for <strong class="text-emerald-600 dark:text-emerald-400">1 plant</strong>. Great start!
    {% else %}
      You're caring for <strong class="text-emerald-600 dark:text-emerald-400">{{ plant_count }} plants</strong>. Nice collection!
    {% endif %}
  </p>
</section>

<!-- Quick Stats -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
  <a href="{{ url_for('plants.index') }}" class="stat-card">
    <div class="text-4xl mb-3" aria-hidden="true">ğŸª´</div>
    <div class="text-3xl font-bold text-slate-900 dark:text-slate-100 mb-1">{{ plant_count }}</div>
    <div class="text-sm text-slate-600 dark:text-slate-400">Plants</div>
  </a>

  <a href="{{ url_for('reminders.index') }}" class="{% if reminder_stats.due_today > 0 %}stat-card-alert{% else %}stat-card{% endif %}">
    <div class="text-4xl mb-3" aria-hidden="true">ğŸ’§</div>
    <div class="text-3xl font-bold {% if reminder_stats.due_today > 0 %}text-amber-700 dark:text-amber-300{% else %}text-slate-900 dark:text-slate-100{% endif %} mb-1">{{ reminder_stats.due_today or 0 }}</div>
    <div class="text-sm {% if reminder_stats.due_today > 0 %}text-amber-700 dark:text-amber-300{% else %}text-slate-600 dark:text-slate-400{% endif %}">Due Today</div>
  </a>

  <a href="{{ url_for('reminders.calendar') }}" class="stat-card">
    <div class="text-4xl mb-3" aria-hidden="true">ğŸ“…</div>
    <div class="text-3xl font-bold text-slate-900 dark:text-slate-100 mb-1">{{ reminder_stats.upcoming_7_days or 0 }}</div>
    <div class="text-sm text-slate-600 dark:text-slate-400">Calendar</div>
  </a>

  <a href="{{ url_for('pricing.index') }}" class="stat-card">
    <div class="text-4xl mb-3" aria-hidden="true">ğŸŒ±</div>
    <div class="text-lg font-bold text-slate-900 dark:text-slate-100 mb-1">Starter</div>
    <div class="text-sm text-slate-600 dark:text-slate-400">Free Forever</div>
  </a>
</div>

<!-- Quick Actions -->
<section class="card mb-8" aria-labelledby="actions-title">
  <h3 id="actions-title" class="section-title">Quick Actions</h3>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
    <a href="/plants/add" class="btn btn-primary">
      <span aria-hidden="true">ğŸª´</span> Add Plant
    </a>
    <a href="{{ url_for('reminders.create') }}" class="btn btn-primary">
      <span aria-hidden="true">ğŸ“</span> New Reminder
    </a>
    <a href="{{ url_for('web.ask_ai') }}" class="btn btn-secondary">
      <span aria-hidden="true">ğŸ¤–</span> Care Assistant
    </a>
    <a href="/plants" class="btn btn-secondary">
      <span aria-hidden="true">ğŸŒ¿</span> View All Plants
    </a>
  </div>
</section>

<!-- Placeholder for Plants (will be implemented in Phase 4) -->
{% if plant_count > 0 %}
<section class="card mb-8" aria-labelledby="plants-title">
  <div class="flex items-center justify-between mb-4">
    <h3 id="plants-title" class="section-title !mb-0">My Plants</h3>
    <a href="/plants" class="text-sm text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300 transition-colors">
      View all â†’
    </a>
  </div>
  <p class="text-slate-500 dark:text-slate-400">Your plants will appear here once you add them.</p>
</section>
{% else %}
<section class="empty-state mb-8" aria-labelledby="empty-title">
  <img src="{{ url_for('static', filename='images/illustrations/seedling-empty-state.svg') }}"
       alt=""
       class="empty-state-illustration"
       aria-hidden="true">
  <h3 id="empty-title" class="text-2xl font-semibold text-slate-900 dark:text-slate-100 mb-2">
    Ready to start your plant collection?
  </h3>
  <p class="text-slate-600 dark:text-slate-400 mb-6 max-w-md">
    Add your first plant to get personalized care reminders and track its growth.
  </p>
  <a href="/plants/add" class="btn btn-primary">
    <span aria-hidden="true">ğŸŒ±</span> Add Your First Plant
  </a>
</section>
{% endif %}

<!-- Care Reminders Due Today -->
{% if due_reminders %}
<section class="card mb-8" aria-labelledby="reminders-title">
  <div class="flex items-center justify-between mb-6">
    <h3 id="reminders-title" class="section-title !mb-0 flex items-center gap-3">
      Care Reminders Due Today
      {% if reminder_stats.due_today > 0 %}
      <span class="badge-amber">{{ reminder_stats.due_today }}</span>
      {% endif %}
    </h3>
    <a href="{{ url_for('reminders.index') }}" class="text-sm text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300 transition-colors">
      View all â†’
    </a>
  </div>

  <div class="space-y-3" id="dashboard-reminders-list">
    {% for reminder in due_reminders[:5] %}
    <div class="flex items-start gap-4 p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700 transition-all duration-200 hover:border-emerald-500 dark:hover:border-emerald-400" data-reminder-id="{{ reminder.id }}">
      <div class="text-2xl flex-shrink-0">
        {% if reminder.reminder_type == 'watering' %}ğŸ’§
        {% elif reminder.reminder_type == 'fertilizing' %}ğŸŒ¿
        {% elif reminder.reminder_type == 'misting' %}ğŸ’¦
        {% elif reminder.reminder_type == 'pruning' %}âœ‚ï¸
        {% elif reminder.reminder_type == 'repotting' %}ğŸª´
        {% elif reminder.reminder_type == 'inspection' %}ğŸ”
        {% else %}ğŸ“{% endif %}
      </div>

      <div class="flex-1 min-w-0">
        <h4 class="font-semibold text-slate-900 dark:text-slate-100 mb-1">
          <a href="{{ url_for('reminders.view', reminder_id=reminder.id) }}" class="hover:text-emerald-600 dark:hover:text-emerald-400 transition-colors">
            {{ reminder.title }}
          </a>
        </h4>
        <p class="text-sm text-slate-600 dark:text-slate-400 flex items-center gap-2 flex-wrap">
          <a href="{{ url_for('plants.view', plant_id=reminder.plant_id) }}" class="text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300">
            {{ reminder.plant_name }}{% if reminder.plant_nickname %} "{{ reminder.plant_nickname }}"{% endif %}
          </a>
          {% if reminder.weather_adjustment_reason %}
          <span class="badge-cyan" title="{{ reminder.weather_adjustment_reason }}">
            <span aria-hidden="true">ğŸŒ¤ï¸</span> Adjusted
          </span>
          {% endif %}
        </p>
      </div>

      <button
        class="btn btn-primary flex-shrink-0 quick-complete-btn"
        data-reminder-id="{{ reminder.id }}"
        data-reminder-title="{{ reminder.title }}"
        title="Mark complete"
      >
        <span aria-hidden="true">âœ“</span> Done
      </button>
    </div>
    {% endfor %}
  </div>

  {% if reminder_stats.due_today > 5 %}
  <div class="text-center text-sm text-slate-500 dark:text-slate-400 mt-4">
    <a href="{{ url_for('reminders.index') }}" class="hover:text-emerald-600 dark:hover:text-emerald-400 transition-colors">
      + {{ reminder_stats.due_today - 5 }} more reminders
    </a>
  </div>
  {% endif %}
</section>
{% elif reminder_stats.active_reminders > 0 %}
<section class="card mb-8" aria-labelledby="reminders-title">
  <div class="flex items-center justify-between mb-4">
    <h3 id="reminders-title" class="section-title !mb-0">Care Reminders</h3>
    <a href="{{ url_for('reminders.index') }}" class="text-sm text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300 transition-colors">
      View all â†’
    </a>
  </div>
  <p class="text-slate-600 dark:text-slate-400">
    <span aria-hidden="true">âœ…</span> No reminders due today! You have {{ reminder_stats.upcoming_7_days }} upcoming in the next 7 days.
  </p>
</section>
{% else %}
<section class="card mb-8" aria-labelledby="reminders-title">
  <h3 id="reminders-title" class="section-title">Care Reminders</h3>
  <p class="text-slate-600 dark:text-slate-400">
    No reminders yet. <a href="{{ url_for('reminders.create') }}" class="text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300 transition-colors">Create your first reminder</a> to stay on top of plant care!
  </p>
</section>
{% endif %}

<!-- CSRF token for AJAX requests (secure storage) -->
<div id="csrf-token" data-csrf="{{ csrf_token() }}" style="display:none;"></div>

<script>
// Quick Complete functionality for dashboard reminders
document.addEventListener('DOMContentLoaded', function() {
  // Get CSRF token securely from data attribute
  const csrfToken = document.getElementById('csrf-token').dataset.csrf;
  const completeButtons = document.querySelectorAll('.quick-complete-btn');

  completeButtons.forEach(button => {
    button.addEventListener('click', async function(e) {
      e.preventDefault();

      const reminderId = this.dataset.reminderId;
      const reminderTitle = this.dataset.reminderTitle;
      const reminderItem = this.closest('[data-reminder-id]');

      // Disable button and show loading state
      this.disabled = true;
      this.innerHTML = 'â³ Completing...';

      try {
        const response = await fetch(`/reminders/api/${reminderId}/complete`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          }
        });

        const data = await response.json();

        if (data.success) {
          // Fade out and remove the reminder item
          reminderItem.style.opacity = '0';
          reminderItem.style.transition = 'opacity 0.3s ease';

          setTimeout(() => {
            reminderItem.remove();

            // Check if list is empty
            const remindersList = document.getElementById('dashboard-reminders-list');
            if (remindersList && remindersList.children.length === 0) {
              // Reload page to update stats and show empty state
              window.location.reload();
            } else {
              // Show success message
              if (window.showToast) {
                window.showToast(`âœ“ ${reminderTitle} marked complete!`, 'success');
              }

              // Update the "Due Today" badge count
              const badge = document.querySelector('#reminders-title .badge');
              if (badge) {
                const currentCount = parseInt(badge.textContent) || 0;
                const newCount = currentCount - 1;
                if (newCount > 0) {
                  badge.textContent = newCount;
                } else {
                  badge.remove();
                }
              }
            }
          }, 300);

        } else {
          // Show error
          this.disabled = false;
          this.innerHTML = 'âœ“ Done';
          if (window.showToast) {
            window.showToast(data.error || 'Failed to complete reminder', 'error');
          } else {
            alert(data.error || 'Failed to complete reminder');
          }
        }
      } catch (error) {
        console.error('Error completing reminder:', error);
        this.disabled = false;
        this.innerHTML = 'âœ“ Done';
        if (window.showToast) {
          window.showToast('Network error. Please try again.', 'error');
        } else {
          alert('Network error. Please try again.');
        }
      }
    });
  });
});
</script>

{% endblock %}