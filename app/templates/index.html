{% extends "base.html" %}

{% block title %}PlantCareAI — AI-Powered Plant Care Assistant • EDH Dev{% endblock %}

{% block description %}Ask for plant care help from an AI-powered assistant that gives practical tips based on your plants and local weather.{% endblock %}

{% block content %}
<section class="card" aria-labelledby="presets-title">
  <h2 id="presets-title" class="section-title">Recommended presets</h2>
  <div id="presets" aria-label="Recommended plant presets">
    <button type="button" class="preset-btn"
            data-plant="Monstera deliciosa"
            data-question="How often should I water?"
            data-context="indoor_potted">
      Monstera, Indoor, Watering
    </button>
    <button type="button" class="preset-btn"
            data-plant="Lavender"
            data-question="How much sun does it need?"
            data-context="outdoor_bed">
      Lavender, Garden bed, Light
    </button>
    <button type="button" class="preset-btn"
            data-plant="Rosemary"
            data-question="Best pot size and soil?"
            data-context="outdoor_potted">
      Rosemary, Outdoor, Pot &amp; soil
    </button>
    <button type="button" class="preset-btn"
            data-plant="Snake Plant"
            data-question="Fertilizer schedule?"
            data-context="indoor_potted">
      Snake Plant, Indoor, Fertilizing
    </button>
  </div>
</section>

<section class="grid-two" aria-labelledby="form-title" aria-busy="false">
  <div class="combined-loading-overlay" role="status" aria-live="polite" aria-atomic="true">
    <div class="spinner" aria-hidden="true"></div>
    <div id="loading-message">Germinating…</div>
  </div>

  <section class="card form-card" aria-labelledby="form-title">
    <h2 id="form-title" class="section-title">Get Plant Care Advice</h2>

    <form id="ask-form" class="form-grid" action="{{ url_for('web.ask') }}" method="post" novalidate>
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <div class="form-row form-row--two">
        <div>
          <label for="plant">Plant (optional)</label>
          <input id="plant" name="plant" type="text" autocomplete="off"
                 placeholder="e.g., Monstera deliciosa"
                 value="{{ (form_values and form_values.plant) or '' }}" />
        </div>
        <div>
          <label for="city">City or ZIP (optional)</label>
          <input id="city" name="city" type="text" autocomplete="off"
                placeholder="e.g., Austin, TX or 73301"
                value="{{ (form_values and form_values.city) or '' }}" />
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="care_context">Where is the plant?</label>
          <select id="care_context" name="care_context" aria-label="Where is the plant?">
            <option value="indoor_potted"
              {% if (form_values and form_values.care_context == 'indoor_potted') or (not form_values) %}selected{% endif %}>
              Potted house plant (indoors)
            </option>
            <option value="outdoor_potted"
              {% if form_values and form_values.care_context == 'outdoor_potted' %}selected{% endif %}>
              Potted plant kept outdoors
            </option>
            <option value="outdoor_bed"
              {% if form_values and form_values.care_context == 'outdoor_bed' %}selected{% endif %}>
              Plant in an outdoor garden bed
            </option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="question">Question</label>
          <textarea id="question" name="question" rows="5"
                    placeholder="e.g., How often should I water?">{{ (form_values and form_values.question) or '' }}</textarea>
        </div>
      </div>

      <div class="actions">
        <button id="submit-btn" class="primary" type="submit">Ask</button>
        <button id="reset-btn" class="secondary" type="button" aria-label="Clear all fields">
          Reset
        </button>
      </div>
    </form>

    {% if ai_error and source == 'rule' %}
      <p class="small muted" role="status" aria-live="polite">
        AI unavailable — showing rule-based tips.
      </p>
    {% endif %}
  </section>

  <section class="card answer-card" aria-labelledby="answer-title" role="region" tabindex="-1">
    {% if answer %}
      <div class="answer-heading">
        <h2 id="answer-title" class="section-title">Answer</h2>
        <div class="small muted">
          Generated by: <strong>{{ source == 'ai' and 'OpenAI' or 'Rule-based engine' }}</strong>
        </div>
      </div>
      <p class="prewrap answer-text">{{ answer }}</p>
    {% else %}
      <h2 id="answer-title" class="section-title">Answer</h2>
      <p class="muted">Submit a question to see guidance here.</p>
    {% endif %}
  </section>
</section>

<!-- Weather (shows when available) -->
<section id="weather-section">
  {% if weather %}
    <div class="weather-header">
      <h2 class="section-title" id="weather-heading">
        Local weather for {{ form_values.city or 'your area' }}
        <span class="visually-hidden">Use the toggle to switch temperature units.</span>
      </h2>
      <!-- Units toggle (right aligned) -->
      <form class="units-toggle" aria-label="Temperature units">
        <fieldset role="radiogroup" aria-label="Select units">
          <label class="toggle-seg">
            <input type="radio" name="units" value="f" checked>
            °F
          </label>
          <label class="toggle-seg">
            <input type="radio" name="units" value="c">
            °C
          </label>
        </fieldset>
      </form>
    </div>

    <!-- Hourly forecast -->
    {% if hourly %}
    <h3 class="section-subtitle">Hourly Forecast <span class="weather-note small muted">&mdash; 3-hour intervals</span></h3>
    <div class="hourly-wrap" aria-label="Hourly forecast for the rest of today">
      <div class="hourly-scroll" role="list">
        {% for h in hourly %}
          <div class="hourly-chip" role="listitem" aria-label="{{ h.time }}">
            <div class="hourly-time">{{ h.time }}</div>
            <div class="hourly-emoji" aria-hidden="true">{{ h.emoji }}</div>
            <div class="hourly-temp">
              <span class="only-f">{{ (h.temp_f is not none) and (h.temp_f|round(0)|string + '°F') or '' }}</span>
              <span class="only-c">{{ (h.temp_c is not none) and (h.temp_c|round(0)|string + '°C') or '' }}</span>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Daily forecast -->
    <h3 class="section-subtitle">Daily Forecast <span class="weather-note small muted">&mdash; Today & next 5 days</span></h3>
    <div class="forecast-grid">
      <!-- Today card -->
      <div class="forecast-card today" aria-labelledby="today-title">
        <div class="forecast-top">
          <div class="forecast-daywrap">
            <div id="today-title" class="forecast-day">Today</div>
            <span class="badge">Now</span>
          </div>
          <div class="forecast-emoji" aria-hidden="true">{{ weather.emoji or '⛅' }}</div>
        </div>

        <div class="forecast-date">{{ today_str }}</div>
        <div class="forecast-desc">{{ (weather.conditions or 'N/A')|capitalize }}</div>

        <div class="forecast-temps">
          <span class="tlabel">Current:</span>
          <span class="only-f">{{ (weather.temp_f is not none) and (weather.temp_f|round(0)|string + '°F') or '—' }}</span>
          <span class="only-c">{{ (weather.temp_c is not none) and (weather.temp_c|round(0)|string + '°C') or '—' }}</span>
        </div>

        <!-- Keep rows consistent across cards; highs/lows optional if you add them later -->
        <div class="forecast-extras small">
          Humidity: {{ weather.humidity }}% • Wind:
          <span class="only-f">{{ weather.wind_mph }} mph</span>
          <span class="only-c">{{ (weather.wind_mps is not none) and (weather.wind_mps|round(1)|string + ' m/s') or '—' }}</span>
        </div>
      </div>

      <!-- Next 5 days (exactly five to keep a total of 6 cards) -->
      {% if forecast %}
        {% for f in forecast[:5] %}
          <div class="forecast-card">
            <div class="forecast-top">
              <div class="forecast-daywrap">
                <div class="forecast-day">{{ f.day }}</div>
              </div>
              <div class="forecast-emoji" aria-hidden="true">{{ f.emoji or '⛅' }}</div>
            </div>

            <div class="forecast-date">{{ f.date }}</div>
            <div class="forecast-desc">{{ (f.conditions or 'N/A')|capitalize }}</div>

            <div class="forecast-temps">
              <span class="tlabel">High:</span>
              <span class="only-f tmax">{{ (f.temp_max_f is not none) and (f.temp_max_f|round(0)|string + '°F') or '—' }}</span>
              <span class="only-c tmax">{{ (f.temp_max_c is not none) and (f.temp_max_c|round(0)|string + '°C') or '—' }}</span>
            </div>
            <div class="forecast-temps">
              <span class="tlabel">Low:</span>
              <span class="only-f tmin">{{ (f.temp_min_f is not none) and (f.temp_min_f|round(0)|string + '°F') or '—' }}</span>
              <span class="only-c tmin">{{ (f.temp_min_c is not none) and (f.temp_min_c|round(0)|string + '°C') or '—' }}</span>
            </div>

            <div class="forecast-extras small">
              Humidity: {{ f.humidity }}% • Wind:
              <span class="only-f">{{ f.wind_mph }} mph</span>
              <span class="only-c">{{ (f.wind_mps is not none) and (f.wind_mps|round(1)|string + ' m/s') or '—' }}</span>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>
  {% elif form_values and form_values.city %}
    <p class="muted">No weather data available for that city or ZIP.</p>
  {% else %}
    <p class="muted">Enter a city or ZIP to include weather insights in the answer.</p>
  {% endif %}
</section>

<section class="card" aria-labelledby="history-title">
  <div class="history-header">
    <h2 id="history-title" class="section-title">Recent Q&amp;A</h2>
    {% if has_history %}
      <a class="muted-link small clear-link" href="{{ url_for('web.clear_history') }}">Clear</a>
    {% endif %}
  </div>

  {% if has_history %}
    <ul class="history">
      {% for item in history %}
        <li>
          <div class="small muted mono">{{ item.ts }}</div>
          <div class="small">
            <span class="mono">{{ item.source == 'ai' and 'AI' or 'Rule' }}</span>
            {% if item.care_context %} • <span class="mono">{{ item.care_context }}</span>{% endif %}
            {% if item.plant %} • <strong>Plant:</strong> {{ item.plant }}{% endif %}
            {% if item.city %} • <strong>City/Zip:</strong> {{ item.city }}{% endif %}
          </div>
          <div class="small history-q"><strong>Q:</strong> {{ item.question }}</div>
          <details class="history-details">
            <summary class="small muted-link">Show answer</summary>
            <pre class="prewrap small history-answer">{{ item.answer }}</pre>
          </details>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">No questions yet. Ask something above to populate the history.</p>
  {% endif %}
</section>
{% endblock %}
