<!--
Main UI template.

Renders the header, recommended presets, a two-column area (form + answer),
a shared loading overlay that covers both columns, then weather and history.
No inline scripts/styles to satisfy the CSP. Uses a global Jinja helper `now()`
(registered in the app factory) for the current date/time.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Plant Care AI Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description"
        content="Ask for plant care help from an AI-powered plant care assistant that gives personalized watering, light, and soil tips based on your plants and local weather." />
  <meta name="theme-color" content="#C2188B" />
  <meta name="author" content="EDH Dev" />

  <!-- Open Graph / social cards -->
  <meta property="og:title" content="Plant Care AI Assistant" />
  <meta property="og:description"
        content="Ask for plant care help and get quick, weather-aware advice powered by AI and expert rules." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="{{ url_for('static', filename='og-preview.png', _external=True) }}" />
  <meta property="og:url" content="{{ request.url_root }}" />

  <!-- Favicons -->
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
  <link rel="alternate icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16.png') }}">
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">
  <meta name="theme-color" content="#C2188B">

  <!-- Local CSS (no CDNs to satisfy CSP) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />

  <meta name="robots" content="index, follow" />
</head>
<body>
  <div class="container">
    <header class="app-header" role="banner">
      <h1>Plant Care AI Assistant</h1>
      <p class="muted">
        Ask for plant care help and get quick, practical advice. Includes weather-aware tips and works with both AI suggestions and reliable fallbacks.
      </p>
      {% set show_debug = (config.UI_DEBUG_LINKS or request.args.get('debug') == 'true') %}
      {% if show_debug %}
        <p class="small">
          <a class="muted-link" href="{{ url_for('web.healthz') }}" target="_blank" rel="noopener">Health check</a>
          &middot;
          <a class="muted-link" href="{{ url_for('web.debug_info') }}" target="_blank" rel="noopener">Debug info</a>
        </p>
      {% endif %}
    </header>

    <main>
      <!-- Recommended presets (compact buttons, optional city, question, and context) -->
      <section class="card" aria-labelledby="presets-title">
        <h2 id="presets-title" class="section-title">Recommended presets</h2>
        <div id="presets" aria-label="Recommended plant presets">
          <button type="button" class="preset-btn"
                  data-plant="Monstera deliciosa"
                  data-question="How often should I water?"
                  data-context="indoor_potted">
            Monstera — watering (indoors)
          </button>
          <button type="button" class="preset-btn"
                  data-plant="Lavender"
                  data-question="How much sun does it need?"
                  data-context="outdoor_bed">
            Lavender — light (garden bed)
          </button>
          <button type="button" class="preset-btn"
                  data-plant="Rosemary"
                  data-question="Best pot size and soil?"
                  data-context="outdoor_potted">
            Rosemary — pot &amp; soil (outdoor pot)
          </button>
          <button type="button" class="preset-btn"
                  data-plant="Snake Plant"
                  data-question="Fertilizer schedule?"
                  data-context="indoor_potted">
            Snake Plant — fertilizing (indoors)
          </button>
        </div>
      </section>

      <!-- Two-column layout on wide screens: shared overlay covers both columns -->
      <section class="grid-two" aria-labelledby="form-title" aria-busy="false">
        <!-- Shared loading overlay spanning both columns -->
        <div class="combined-loading-overlay" role="status" aria-live="polite" aria-atomic="true">
          <div class="spinner" aria-hidden="true"></div>
          <div>Thinking…</div>
        </div>

        <!-- Form -->
        <section class="card form-card" aria-labelledby="form-title">
          <h2 id="form-title" class="section-title">Ask for advice</h2>

          <form id="ask-form" class="form-grid" action="{{ url_for('web.ask') }}" method="post" novalidate>
            <div class="form-row form-row--two">
              <div>
                <label for="plant">Plant (optional)</label>
                <input id="plant" name="plant" type="text" autocomplete="off"
                       placeholder="e.g., Monstera deliciosa"
                       value="{{ (form_values and form_values.plant) or '' }}" />
              </div>
              <div>
                <label for="city">City or ZIP (optional)</label>
                <input id="city" name="city" type="text" autocomplete="off"
                      placeholder="e.g., Austin, TX or 73301"
                      value="{{ (form_values and form_values.city) or '' }}" />
              </div>
            </div>

            <div class="form-row">
              <div>
                <label for="care_context">Where is the plant?</label>
                <select id="care_context" name="care_context" aria-label="Where is the plant?">
                  <option value="indoor_potted"
                    {% if (form_values and form_values.care_context == 'indoor_potted') or (not form_values) %}selected{% endif %}>
                    Potted house plant (indoors)
                  </option>
                  <option value="outdoor_potted"
                    {% if form_values and form_values.care_context == 'outdoor_potted' %}selected{% endif %}>
                    Potted plant kept outdoors
                  </option>
                  <option value="outdoor_bed"
                    {% if form_values and form_values.care_context == 'outdoor_bed' %}selected{% endif %}>
                    Plant in an outdoor garden bed
                  </option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div>
                <label for="question">Question</label>
                <textarea id="question" name="question" rows="5"
                          placeholder="e.g., How often should I water?">{{ (form_values and form_values.question) or '' }}</textarea>
              </div>
            </div>

            <div class="actions">
              <button id="submit-btn" class="primary" type="submit">Ask</button>
              {% if form_values %}
                <span class="small muted">Last submitted:
                  <span class="mono">{{ form_values.care_context or 'indoor_potted' }}</span>
                </span>
              {% endif %}
            </div>
          </form>

          {% if ai_error and source == 'rule' %}
            <p class="small muted" role="status" aria-live="polite">
              AI unavailable: {{ ai_error }} — using rule-based advice.
            </p>
          {% endif %}
        </section>

        <!-- Answer (focusable region so JS can move focus here after submit) -->
        <section class="card answer-card" aria-labelledby="answer-title" role="region" tabindex="-1">
          <h2 id="answer-title" class="section-title">Answer</h2>
          {% if answer %}
            <p class="small muted">
              Generated by: <strong>{{ source == 'ai' and 'OpenAI (fallback-safe)' or 'Rule-based engine' }}</strong>
            </p>
            <pre class="prewrap">{{ answer }}</pre>
          {% else %}
            <p class="muted">Submit a question to see guidance here.</p>
          {% endif %}
        </section>
      </section>

      <!-- Weather (shows when available) -->
      <section id="weather-section">
        {% if weather %}
        <h2 class="section-title">Local Weather</h2>
        <div class="forecast-grid">
         <!-- Today card -->
          <div class="forecast-card today">
            <div class="forecast-top">
              <div class="forecast-daywrap">
                <span class="forecast-day">Today</span>
              </div>
              <div class="forecast-date">{{ now().strftime('%Y-%m-%d') }}</div>
            </div>
            <div class="forecast-temps">
              <span class="tmax">{{ weather.temp_f | round(0) }}°F</span>
            </div>
            <div class="forecast-extras">
              <div class="forecast-desc">
                <span class="forecast-emoji" aria-label="{{ weather.conditions }}">{{ weather.emoji }}</span>
                {{ weather.conditions|capitalize }}
              </div>
              <div class="small muted">Humidity: {{ weather.humidity }}% • Wind: {{ weather.wind_mph }} mph</div>
            </div>
          </div>
          <!-- 5-day forecast cards -->
          {% if forecast %}
            {% for f in forecast %}
            <div class="forecast-card">
              <div class="forecast-top">
                <div class="forecast-daywrap">
                  <span class="forecast-day">{{ f.day }}</span>
                </div>
                <div class="forecast-date">{{ f.date }}</div>
              </div>
              <div class="forecast-temps">
                <span class="tmax">{{ f.temp_max_f|round(0) }}°F</span>
                <span class="tparen">/</span>
                <span class="tmin">{{ f.temp_min_f|round(0) }}°F</span>
              </div>
              <div class="forecast-extras">
                <div class="forecast-desc">
                  <span class="forecast-emoji" aria-label="{{ f.conditions }}">{{ f.emoji }}</span>
                  {{ f.conditions|capitalize }}
                </div>
                <div class="small muted">Humidity: {{ f.humidity }}% • Wind: {{ f.wind_mph }} mph</div>
              </div>
            </div>
            {% endfor %}
          {% endif %}

        </div>
        {% elif form_values and form_values.city %}
        <p class="muted">No weather data available for that city or ZIP.</p>
        {% else %}
        <p class="muted">Enter a city or ZIP to include a short weather tip in the answer.</p>
        {% endif %}
      </section>

      <!-- History -->
      <section class="card" aria-labelledby="history-title">
        <div class="history-header">
          <h2 id="history-title" class="section-title">Recent Q&amp;A</h2>
          {% if has_history %}
            <a class="muted-link small" href="{{ url_for('web.clear_history') }}">Clear</a>
          {% endif %}
        </div>

        {% if has_history %}
          <ul class="history">
            {% for item in history %}
              <li>
                <div class="small muted mono">{{ item.ts }}</div>
                <div class="small">
                  <span class="mono">{{ item.source == 'ai' and 'AI' or 'Rule' }}</span>
                  {% if item.care_context %} • <span class="mono">{{ item.care_context }}</span>{% endif %}
                  {% if item.plant %} • <strong>Plant:</strong> {{ item.plant }}{% endif %}
                  {% if item.city %} • <strong>City:</strong> {{ item.city }}{% endif %}
                </div>
                <div class="small history-q"><strong>Q:</strong> {{ item.question }}</div>
                <details class="history-details">
                  <summary class="small muted-link">Show answer</summary>
                  <pre class="prewrap small history-answer">{{ item.answer }}</pre>
                </details>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="muted">No questions yet. Ask something above to populate the history.</p>
        {% endif %}
      </section>

    </main>
  </div>

  <footer class="site-footer" role="contentinfo">
    <p>&copy; <span id="copyright-year"></span> <a href="https://ehermance.github.io" rel="noopener">EDH Dev</a> — Built with care</p>
  </footer>

  <!-- Local JS (no inline scripts for CSP) -->
  <script src="{{ url_for('static', filename='app.js') }}" defer></script>
</body>
</html>
