<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Plant Care AI Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script defer src="{{ url_for('static', filename='app.js') }}"></script>
</head>
<body>
  <!-- Header with consistent left/right gutter -->
  <header class="page-header container">
    <h1>Plant Care AI Assistant</h1>
    <p class="muted">
      Rule-based ➜ Weather-aware ➜ (optional) OpenAI, with graceful fallback.
    </p>
  </header>

  <!-- Main content container -->
  <main id="main" role="main" class="container">

    <!-- Recommended Presets -->
    <section class="recommended">
      <h2>Recommended Presets</h2>
      <div class="preset-grid">
        <button type="button" data-plant="Monstera" class="preset-btn">Monstera</button>
        <button type="button" data-plant="Fiddle Leaf Fig" class="preset-btn">Fiddle Leaf Fig</button>
        <button type="button" data-plant="Snake Plant" class="preset-btn">Snake Plant</button>
        <button type="button" data-plant="Peace Lily" class="preset-btn">Peace Lily</button>
      </div>
    </section>

    <!-- Q&A Form -->
    <section aria-labelledby="ask-form-heading" class="card">
      <h2 id="ask-form-heading">Ask a Plant Question</h2>
      <form action="{{ url_for('web.ask') }}" method="post" id="ask-form">
        <div class="form-row">
          <label for="plant">Plant (optional)</label>
          <input id="plant" name="plant" type="text"
                 placeholder="e.g., Monstera deliciosa"
                 value="{{ (form_values and form_values.plant) or '' }}">
        </div>

        <div class="form-row">
          <label for="city">City (optional)</label>
          <input id="city" name="city" type="text"
                 placeholder="e.g., Austin, TX"
                 value="{{ (form_values and form_values.city) or '' }}">
        </div>

        <div class="form-row">
          <label for="question">Your question</label>
          <textarea id="question" name="question" rows="4"
                    placeholder="e.g., How often should I water?">{{ (form_values and form_values.question) or '' }}</textarea>
        </div>

        <button class="primary" type="submit" id="submit-btn">Ask</button>
        <span class="form-hint muted">
          <a class="link" href="{{ url_for('web.healthz') }}" target="_blank">Health check</a> |
          <a class="link" href="{{ url_for('web.debug_info') }}" target="_blank">Debug info</a>
        </span>
      </form>
    </section>

    <!-- Answer -->
    {% if answer %}
    <section class="card answer-card">
      <div class="answer-header">
        <h2>Answer</h2>
        {% if source %}
        <span class="pill" title="How this answer was generated">
          {{ source == 'ai' and 'AI' or 'Rule' }}
        </span>
        {% endif %}
      </div>

      {% if ai_error and source == 'rule' %}
      <div class="notice small">
        <strong>AI unavailable</strong>: {{ ai_error }}<br>
        Fell back to rule-based advice. Check <a class="link" href="/debug" target="_blank">/debug</a>.
      </div>
      {% endif %}

      <pre class="answer-text">{{ answer }}</pre>
      <p class="muted small">
        Generated by: <strong>{{ source == 'ai' and 'OpenAI (fallback-safe)' or 'Rule-based engine' }}</strong>
      </p>
    </section>
    {% endif %}

    <!-- Weather Info -->
    {% if weather %}
    <section class="card">
      <h2>Local Weather</h2>
      <p>
        <strong>{{ weather.city }}</strong> — {{ weather.conditions or 'N/A' }}<br>
        Temp: {{ weather.temp_c }} °C • Humidity: {{ weather.humidity }}% • Wind: {{ weather.wind_mps }} m/s
      </p>
    </section>
    {% endif %}

    <!-- History -->
    <section class="card">
      <div class="section-header">
        <h2>Recent Q&A</h2>
        <a class="link small" href="{{ url_for('web.clear_history') }}">Clear</a>
      </div>
      {% if history and history|length > 0 %}
      <ul class="history">
        {% for item in history %}
        <li>
          <div class="small muted mono">{{ item.ts }}</div>
          <div class="small">
            <span class="pill">{{ item.source == 'ai' and 'AI' or 'Rule' }}</span>
            {% if item.plant %}<strong>Plant:</strong> {{ item.plant }} • {% endif %}
            {% if item.city %}<strong>City:</strong> {{ item.city }}{% endif %}
          </div>
          <div class="small"><strong>Q:</strong> {{ item.question }}</div>
          <details>
            <summary class="small link">Show answer</summary>
            <pre class="small">{{ item.answer }}</pre>
          </details>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="muted small">No questions yet. Ask something above to populate the history.</p>
      {% endif %}
    </section>
  </main>
</body>
</html>
